{"componentChunkName":"component---node-modules-gatsby-theme-apollo-docs-src-components-template-js","path":"/v1.2/installation/with-aad-pod-identity/","result":{"data":{"site":{"pathPrefix":"","siteMetadata":{"title":"akv2k8s docs","description":"How to get Azure Key Vault objects into Kubernetes"}},"file":{"childMarkdownRemark":{"frontmatter":{"title":"Add Exception for aad-pod-identity","description":"Learn what needs to be done to run successfully with aad-pod-identity"},"headings":[{"value":"When is <code class=\"language-text\">AzurePodIdentityException</code> required?"},{"value":"How to add the <code class=\"language-text\">AzurePodIdentityException</code>"}],"fields":{"image":"social-cards/with-aad-pod-identity.png","graphManagerUrl":""},"htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In order to use Managed Identities with Pods, Microsoft have developed a open source project called aad-pod-identity or Azure Active Directory Pod Identity for Kubernetes. In order for akv2k8s to run successfully in the same cluster as aad-pod-identity, a "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"AzurePodIdentityException"}]},{"type":"text","value":" must be added for akv2k8s."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"when-is-azurepodidentityexception-required","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#when-is-azurepodidentityexception-required","ariaLabel":"when is azurepodidentityexception required permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"When is "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"AzurePodIdentityException"}]},{"type":"text","value":" required?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If all of these conditions are true, a "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"AzurePodIdentityException"}]},{"type":"text","value":" must be added for akv2k8s to work successfully:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The Kubernetes cluster has aad-pod-identity installed"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The Kubernetes cluster is using Managed Identity as its primary identity"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Akv2k8s is using default authentication ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"keyVaultAuth=azureCloudConfig"}]},{"type":"text","value":")"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"how-to-add-the-azurepodidentityexception","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#how-to-add-the-azurepodidentityexception","ariaLabel":"how to add the azurepodidentityexception permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"How to add the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"AzurePodIdentityException"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The akv2k8s Helm chart has a simple setting for this. Just set "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"addAzurePodIdentityException=true"}]},{"type":"text","value":" and a AzurePodIdentityException will be added to Kubernetes."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"why","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#why","ariaLabel":"why permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Why?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As documented by "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"aad-pod-identity"}]},{"type":"text","value":":"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The authorization request to fetch a Service Principal Token from an MSI endpoint is sent to Azure Instance Metadata Service (IMDS) endpoint (169.254.169.254), "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"which is redirected to the NMI pod"}]},{"type":"text","value":". "}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Identity assignment on VM takes 10-20s and 40-60s in case of VMSS."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This will effectively prevent akv2k8s to do MSI authentication requests directly with the MSI endpoint (using Managed Identity with Azure Key Vault) and both the Controller and Evn Injector will fail during startup."}]}],"data":{"quirksMode":false}}},"childMdx":null}},"pageContext":{"id":"c2f3655e-b8d2-5673-b121-461fbf19f545","subtitle":"","versionDifference":-0.19999999999999996,"versionBasePath":"/v1.2","sidebarContents":[{"title":null,"pages":[{"title":"Overview","sidebarTitle":"","description":"Explore Azure Key Vault to Kubernetes","path":"/v1.2/"},{"title":"Why use akv2k8s?","sidebarTitle":"","description":null,"path":"/v1.2/why-akv2k8s/"},{"title":"Quick Start","sidebarTitle":"","description":"Quickly get started using Azure Key Vault to Kubernetes","path":"/v1.2/quick-start/"},{"title":"How it Works","sidebarTitle":"","description":"Learn about the inner workings of akv2k8s.","path":"/v1.2/how-it-works/"},{"title":"FAQ","sidebarTitle":"","description":"Most frequently asked questions","path":"/v1.2/faq/"}]},{"title":"Installation","pages":[{"title":"Overview","sidebarTitle":"","description":"Different options for installing akv2k8s","path":"/v1.2/installation/"},{"title":"Requirements","sidebarTitle":"","description":"Requirements for installing akv2k8s","path":"/v1.2/installation/requirements/"},{"title":"Installing on Azure AKS","sidebarTitle":"","description":"How to install Azure Key Vault to Kubernetes (akv2k8s) on Azure AKS","path":"/v1.2/installation/on-azure-aks/"},{"title":"Installing outside Azure AKS","sidebarTitle":"","description":"Learn how to install Azure Key Vault to Kubernetes outside Azure AKS","path":"/v1.2/installation/outside-azure-aks/"},{"title":"Updating akv2k8s CRDs","sidebarTitle":"","description":"How to update akv2k8s Custom Resource Definitions (CRDs)","path":"/v1.2/installation/crd/"},{"title":"Installation without Helm","sidebarTitle":"","description":"How to setup Azure Key Vault to Kubernetes","path":"/v1.2/installation/without-helm/"},{"title":"Upgrade","sidebarTitle":"","description":"How to upgrade Azure Key Vault to Kubernetes","path":"/v1.2/installation/upgrade/"},{"title":"Add Exception for aad-pod-identity","sidebarTitle":"","description":"Learn what needs to be done to run successfully with aad-pod-identity","path":"/v1.2/installation/with-aad-pod-identity/"}]},{"title":"Tutorials","pages":[{"title":"Tutorials","sidebarTitle":"","description":"A quick introduction to the tutorials","path":"/v1.2/tutorials/"},{"title":"Prerequisites","sidebarTitle":"","description":"A quick overview of the prerequisites needed to complete the tutorials","path":"/v1.2/tutorials/prerequisites/"},{"title":"Sync Secret","sidebarTitle":"","description":"Sync a secret from Azure Key Vault into a Kubernetes Secret","path":"/v1.2/tutorials/sync/1-secret/"},{"title":"Sync Certificate","sidebarTitle":"","description":"Sync a certificate from Azure Key Vault into a Kubernetes Secret.","path":"/v1.2/tutorials/sync/2-certificate/"},{"title":"Sync Signing Key","sidebarTitle":"","description":"Sync signing key from Azure Key Vault into a Kubernetes Secret","path":"/v1.2/tutorials/sync/3-signing-key/"},{"title":"Sync Multi Key Value Secret","sidebarTitle":"","description":"Sync a multi-key-value secret from Azure Key Vault into a Kubernetes Secret","path":"/v1.2/tutorials/sync/4-multi-key-value-secret/"},{"title":"Sync Multiple AKVS to One Secret","sidebarTitle":"","description":"Sync multiple AzureKeyVaultSecrets to a single Kubernetes Secret","path":"/v1.2/tutorials/sync/5-multi-akvs-to-one-secret/"},{"title":"Sync Secret to ConfigMap","sidebarTitle":"","description":"Sync a secret from Azure Key Vault into a Kubernetes ConfigMap","path":"/v1.2/tutorials/sync/6-secret-to-configmap/"},{"title":"Inject Secret","sidebarTitle":"","description":"Inject an Azure Key Vault secret directly into a container application","path":"/v1.2/tutorials/env-injection/1-secret/"},{"title":"Inject Certificate","sidebarTitle":"","description":"Inject an Azure Key Vault certificate key pair directly into a container application","path":"/v1.2/tutorials/env-injection/2-certificate/"},{"title":"Inject Signing Key","sidebarTitle":"","description":"Inject a signing key from Azure Key Vault as environment variable into an application","path":"/v1.2/tutorials/env-injection/3-signing-key/"},{"title":"Inject PFX Certificate","sidebarTitle":"","description":"Inject a PFX certificate from Azure Key Vault as environment variables into an application","path":"/v1.2/tutorials/env-injection/5-pfx-certificate/"}]},{"title":"Security","pages":[{"title":"Authentication with Azure Key Vault","sidebarTitle":"","description":"Learn about the different options for authenticating with Azure Key Vault.","path":"/v1.2/security/authentication/"},{"title":"Authorization","sidebarTitle":"","description":"Learn how to set the proper access rights in Azure Key Vault","path":"/v1.2/security/authorization/"},{"title":"Enable Environment Injecton","sidebarTitle":"","description":"Learn how to enable environment injection per Kubernetes namespace","path":"/v1.2/security/enable-env-injection/"}]},{"title":"Monitoring","pages":[{"title":"Logs","sidebarTitle":"","description":"Akv2k8s logs","path":"/v1.2/monitoring/logs/"},{"title":"Metrics","sidebarTitle":"","description":"Akv2k8s metrics","path":"/v1.2/monitoring/metrics/"}]},{"title":"Troubleshooting","pages":[{"title":"Get the akv2k8s Controller Log","sidebarTitle":"","description":"How to access the Controller log and specify log level","path":"/v1.2/troubleshooting/controller-log/"},{"title":"Set env-injector log-level","sidebarTitle":"","description":"How to set the log-level for the env-injector","path":"/v1.2/troubleshooting/env-injector-log-level/"},{"title":"Known Issues","sidebarTitle":"","description":"A list of known issues and available solutions or workarounds","path":"/v1.2/troubleshooting/known-issues/"}]},{"title":"Reference","pages":[{"title":"AzureKeyVaultSecret","sidebarTitle":"","description":"Reference of AzureKeyVaultSecret custom resource definition","path":"/v1.2/reference/azure-key-vault-secret/"}]}],"githubUrl":"https://github.com/sparebankenvest/akv2k8s-website/tree/v1.2.3/source/content/installation/with-aad-pod-identity.md","spectrumUrl":"","twitterHandle":"","versions":["1.5-beta","1.3","1.2","1.1","1.0"],"defaultVersion":"1.4","baseUrl":"https://akv2k8s.io"}},"staticQueryHashes":["1511030359","2468095761","2468095761","426988268","426988268"]}